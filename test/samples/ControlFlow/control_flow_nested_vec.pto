module {
  func.func @control_flow_nested_vec_block(%input: !pto.ptr<f32>, %output: !pto.ptr<f32>) {
    %c0 = arith.constant 0 : index
    %c1 = arith.constant 1 : index
    %c2 = arith.constant 2 : index
    %c3 = arith.constant 3 : index
    %c32 = arith.constant 32 : index
    %c64 = arith.constant 64 : index
    %alpha = arith.constant 2.500000e-01 : f32
    %beta = arith.constant 1.250000e+00 : f32
    %neg1 = arith.constant -1.000000e+00 : f32

    // Input: 64x32 (2 blocks of 32x32), Output: 32x32
    %in_tv = pto.make_tensor_view %input, shape = [%c64, %c32] strides = [%c32, %c1] : !pto.tensor_view<?x?xf32>
    %out_tv = pto.make_tensor_view %output, shape = [%c32, %c32] strides = [%c32, %c1] : !pto.tensor_view<?x?xf32>

    %out_pt = pto.partition_view %out_tv, offsets = [%c0, %c0], sizes = [%c32, %c32] : !pto.tensor_view<?x?xf32> -> !pto.partition_tensor_view<32x32xf32>

    %data_vec = pto.alloc_tile : !pto.tile_buf<loc=vec, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>
    %acc_vec = pto.alloc_tile : !pto.tile_buf<loc=vec, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>
    %tmp_vec = pto.alloc_tile : !pto.tile_buf<loc=vec, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>

    // Initialize accumulator: load first block
    %init_pt = pto.partition_view %in_tv, offsets = [%c0, %c0], sizes = [%c32, %c32] : !pto.tensor_view<?x?xf32> -> !pto.partition_tensor_view<32x32xf32>
    pto.tload ins(%init_pt : !pto.partition_tensor_view<32x32xf32>) outs(%acc_vec : !pto.tile_buf<loc=vec, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>)

    // Outer loop: iterate over input blocks
    scf.for %i = %c0 to %c2 step %c1 {
      // Compute offset for this block
      %row_off = arith.muli %i, %c32 : index
      %in_pt = pto.partition_view %in_tv, offsets = [%row_off, %c0], sizes = [%c32, %c32] : !pto.tensor_view<?x?xf32> -> !pto.partition_tensor_view<32x32xf32>

      // Load input block
      pto.tload ins(%in_pt : !pto.partition_tensor_view<32x32xf32>) outs(%data_vec : !pto.tile_buf<loc=vec, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>)

      // Inner loop: multi-step vector computation
      scf.for %j = %c0 to %c3 step %c1 {
        // tmp = data * alpha
        pto.tmuls ins(%data_vec, %alpha : !pto.tile_buf<loc=vec, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>, f32) outs(%tmp_vec : !pto.tile_buf<loc=vec, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>)
        // acc = acc + tmp
        pto.tadd ins(%acc_vec, %tmp_vec : !pto.tile_buf<loc=vec, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>, !pto.tile_buf<loc=vec, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>) outs(%acc_vec : !pto.tile_buf<loc=vec, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>)
        // data = data * beta (update for next inner iteration)
        pto.tmuls ins(%data_vec, %beta : !pto.tile_buf<loc=vec, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>, f32) outs(%data_vec : !pto.tile_buf<loc=vec, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>)
      }
    }

    // Final scale
    pto.tmuls ins(%acc_vec, %neg1 : !pto.tile_buf<loc=vec, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>, f32) outs(%acc_vec : !pto.tile_buf<loc=vec, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>)

    pto.tstore ins(%acc_vec : !pto.tile_buf<loc=vec, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>) outs(%out_pt : !pto.partition_tensor_view<32x32xf32>)
    return
  }
}
