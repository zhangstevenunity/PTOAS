name: Build Wheel

on:
  push:
    branches: [main, master, ci_wheel]
  pull_request:
  workflow_dispatch:

env:
  LLVM_TAG: llvmorg-19.1.7

jobs:
  build_wheel:
    name: Build wheel (Python ${{ matrix.python }}, ${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python: ["3.11"]
        arch: [x86_64]
        # Extend for more versions:
        # python: ["3.9", "3.10", "3.11", "3.12"]

    container:
      image: quay.io/pypa/manylinux_2_34_${{ matrix.arch }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set Python version
        run: |
          # Map Python version to manylinux path
          case "${{ matrix.python }}" in
            "3.9")  PY_VER="cp39-cp39" ;;
            "3.10") PY_VER="cp310-cp310" ;;
            "3.11") PY_VER="cp311-cp311" ;;
            "3.12") PY_VER="cp312-cp312" ;;
            *)      PY_VER="cp311-cp311" ;;
          esac
          echo "PY_VER=$PY_VER" >> $GITHUB_ENV
          echo "PY_PATH=/opt/python/$PY_VER" >> $GITHUB_ENV

      - name: Install system dependencies
        run: |
          dnf install -y ninja-build cmake git ccache gcc-c++ lld zip
          dnf clean all

      - name: Install Python dependencies
        run: |
          export PATH="${PY_PATH}/bin:$PATH"
          pip install --no-cache-dir numpy pybind11 nanobind setuptools wheel auditwheel

      - name: Set build directories
        run: |
          echo "WORKSPACE_DIR=/llvm-workspace" >> $GITHUB_ENV
          echo "LLVM_SOURCE_DIR=/llvm-workspace/llvm-project" >> $GITHUB_ENV
          echo "LLVM_BUILD_DIR=/llvm-workspace/llvm-project/build-shared" >> $GITHUB_ENV
          echo "PTO_SOURCE_DIR=$GITHUB_WORKSPACE" >> $GITHUB_ENV
          echo "PTO_INSTALL_DIR=$GITHUB_WORKSPACE/install" >> $GITHUB_ENV

      - name: Cache LLVM build
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: /llvm-workspace/llvm-project/build-shared
          key: llvm-${{ env.LLVM_TAG }}-manylinux_2_34-${{ matrix.arch }}-${{ matrix.python }}-v1

      - name: Clone LLVM
        run: |
          mkdir -p $WORKSPACE_DIR
          cd $WORKSPACE_DIR
          if [ ! -d llvm-project ]; then
            git clone --depth 1 --branch ${{ env.LLVM_TAG }} https://github.com/llvm/llvm-project.git
          fi

      - name: Build LLVM/MLIR
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          export PATH="${PY_PATH}/bin:$PATH"
          cd $LLVM_SOURCE_DIR
          cmake -G Ninja -S llvm -B $LLVM_BUILD_DIR \
            -DLLVM_ENABLE_PROJECTS="mlir;clang" \
            -DBUILD_SHARED_LIBS=ON \
            -DMLIR_ENABLE_BINDINGS_PYTHON=ON \
            -DPython3_EXECUTABLE=${PY_PATH}/bin/python \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_TARGETS_TO_BUILD="host"
          ninja -C $LLVM_BUILD_DIR

      - name: Build PTOAS
        run: |
          export PATH="${PY_PATH}/bin:$PATH"
          cd $PTO_SOURCE_DIR
          cmake -G Ninja \
            -S . \
            -B build \
            -DLLVM_DIR=$LLVM_BUILD_DIR/lib/cmake/llvm \
            -DMLIR_DIR=$LLVM_BUILD_DIR/lib/cmake/mlir \
            -DPython3_ROOT_DIR=${PY_PATH} \
            -DPython3_EXECUTABLE=${PY_PATH}/bin/python \
            -DPython3_FIND_STRATEGY=LOCATION \
            -Dpybind11_DIR=$(${PY_PATH}/bin/python -m pybind11 --cmakedir) \
            -DMLIR_PYTHON_PACKAGE_DIR=${LLVM_BUILD_DIR}/tools/mlir/python_packages/mlir_core \
            -DCMAKE_INSTALL_PREFIX=${PTO_INSTALL_DIR}
          ninja -C build
          ninja -C build install

      - name: Create Python wheel
        run: |
          export PATH="${PY_PATH}/bin:$PATH"
          export PY_PACKAGE_DIR=$LLVM_BUILD_DIR/tools/mlir/python_packages/mlir_core
          
          # Copy PTO dialect files to MLIR package directory
          cp $PTO_INSTALL_DIR/mlir/dialects/*.py $PY_PACKAGE_DIR/mlir/dialects/
          
          # Copy setup.py to package directory
          cp $PTO_SOURCE_DIR/docker/setup.py $PY_PACKAGE_DIR/
          
          # Build the wheel
          cd $PY_PACKAGE_DIR
          python setup.py bdist_wheel

      - name: Repair wheel with auditwheel
        run: |
          export PATH="${PY_PATH}/bin:$PATH"
          export PY_PACKAGE_DIR=$LLVM_BUILD_DIR/tools/mlir/python_packages/mlir_core
          export LD_LIBRARY_PATH=$LLVM_BUILD_DIR/lib:$PTO_INSTALL_DIR/lib:$LD_LIBRARY_PATH
          
          cd $PY_PACKAGE_DIR
          auditwheel repair --plat manylinux_2_34_${{ matrix.arch }} dist/ptoas*.whl -w wheelhouse

      - name: Test wheel installation
        run: |
          export PATH="${PY_PATH}/bin:$PATH"
          export PY_PACKAGE_DIR=$LLVM_BUILD_DIR/tools/mlir/python_packages/mlir_core
          
          pip install $PY_PACKAGE_DIR/wheelhouse/ptoas*.whl
          
          # Test imports in a clean directory
          cd /tmp
          python -c "import mlir.ir; print('mlir.ir imported successfully')"
          python -c "from mlir.dialects import pto; print('pto dialect imported successfully')"

      - name: Test ptoas CLI
        run: |
          export PATH="${PY_PATH}/bin:$PATH"
          export PATH=$PTO_SOURCE_DIR/build/tools/ptoas:$PATH
          export PYTHONPATH=$LLVM_BUILD_DIR/tools/mlir/python_packages/mlir_core:$PTO_INSTALL_DIR:$PYTHONPATH
          export LD_LIBRARY_PATH=$LLVM_BUILD_DIR/lib:$PTO_INSTALL_DIR/lib:$LD_LIBRARY_PATH
          
          which ptoas
          
          # Test MatMul sample
          cd $PTO_SOURCE_DIR/test/samples/MatMul/
          python ./tmatmulk.py > ./tmatmulk.pto
          ptoas ./tmatmulk.pto -o ./tmatmulk.cpp
          
          # Test Abs sample
          cd $PTO_SOURCE_DIR/test/samples/Abs/
          python ./abs.py > ./abs.pto
          ptoas --enable-insert-sync ./abs.pto -o ./abs.cpp

      - name: Copy wheel to workspace
        run: |
          export PY_PACKAGE_DIR=$LLVM_BUILD_DIR/tools/mlir/python_packages/mlir_core
          mkdir -p $GITHUB_WORKSPACE/wheelhouse
          cp $PY_PACKAGE_DIR/wheelhouse/ptoas*.whl $GITHUB_WORKSPACE/wheelhouse/

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: ptoas-wheel-py${{ matrix.python }}-${{ matrix.arch }}
          path: wheelhouse/*.whl

      - name: Collect ptoas binary and dependencies
        run: |
          export LD_LIBRARY_PATH=$LLVM_BUILD_DIR/lib:$PTO_INSTALL_DIR/lib:$LD_LIBRARY_PATH
          
          PTOAS_BIN=$PTO_SOURCE_DIR/build/tools/ptoas/ptoas
          PTOAS_DIST_DIR=$GITHUB_WORKSPACE/ptoas-dist
          PTOAS_DEPS_DIR=$PTOAS_DIST_DIR/lib
          
          mkdir -p $PTOAS_DIST_DIR/bin $PTOAS_DEPS_DIR
          
          # Copy ptoas binary
          cp $PTOAS_BIN $PTOAS_DIST_DIR/bin/
          
          # Collect *.so dependencies (transitive closure under /llvm-workspace)
          copy_so() {
            local f="$1"
            [[ -f "$f" ]] || return 0
            local name=$(basename "$f")
            [[ -f "${PTOAS_DEPS_DIR}/${name}" ]] && return 0
            cp -n "$f" "${PTOAS_DEPS_DIR}/" 2>/dev/null || true
            while read -r res; do
              copy_so "$res"
            done < <(ldd "$f" 2>/dev/null | awk '/=> \/llvm-workspace\// {print $3}')
          }
          
          while read -r res; do
            copy_so "$res"
          done < <(ldd "$PTOAS_BIN" 2>/dev/null | awk '/=> \/llvm-workspace\// {print $3}')
          
          # Create a wrapper script for convenience
          cat > $PTOAS_DIST_DIR/ptoas << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${LD_LIBRARY_PATH}"
          exec "${SCRIPT_DIR}/bin/ptoas" "$@"
          EOF
          chmod +x $PTOAS_DIST_DIR/ptoas
          
          # Show collected files
          echo "=== ptoas distribution contents ==="
          ls -la $PTOAS_DIST_DIR/
          ls -la $PTOAS_DIST_DIR/bin/
          echo "=== Collected .so dependencies ($(ls $PTOAS_DEPS_DIR/*.so* 2>/dev/null | wc -l) files) ==="
          du -sh $PTOAS_DEPS_DIR/

      - name: Upload ptoas binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ptoas-bin-${{ matrix.arch }}
          path: ptoas-dist/

  collect_artifacts:
    name: Collect all artifacts
    needs: build_wheel
    runs-on: ubuntu-latest
    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-wheels
          pattern: ptoas-wheel-*
          merge-multiple: true

      - name: Download all ptoas binary artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-ptoas-bin
          pattern: ptoas-bin-*
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "=== Wheels ==="
          ls -la all-wheels/
          echo "=== ptoas binaries ==="
          ls -laR all-ptoas-bin/

      - name: Upload combined wheels
        uses: actions/upload-artifact@v4
        with:
          name: ptoas-wheels-all
          path: all-wheels/*.whl

      - name: Upload combined ptoas binaries
        uses: actions/upload-artifact@v4
        with:
          name: ptoas-bin-all
          path: all-ptoas-bin/
