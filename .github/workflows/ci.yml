name: CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-22.04
    env:
      LLVM_COMMIT: e21dc4bd5474d04b8e62d7331362edcc5648d7e5
      LLVM_DIR: ${{ github.workspace }}/llvm-project/llvm/build-shared
      PTO_INSTALL_DIR: ${{ github.workspace }}/install
      MLIR_PYTHONPATH: ${{ github.workspace }}/llvm-project/llvm/build-shared/tools/mlir/python_packages/mlir_core
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake git ninja-build \
            python3 python3-pip python3-venv \
            clang lld \
            libedit-dev zlib1g-dev libxml2-dev libzstd-dev
          python3 -m pip install --upgrade pip
          python3 -m pip install pybind11 numpy

      # 先恢复 LLVM build 缓存
      - name: Restore LLVM build cache
        id: cache-llvm
        uses: actions/cache/restore@v4
        with:
          path: |
            llvm-project/llvm/build-shared
          key: llvm-${{ runner.os }}-${{ env.LLVM_COMMIT }}-shared-mlirpy

      - name: Prepare LLVM source (no rebuild)
        run: |
          mkdir -p llvm-project
          cd llvm-project

          # 如果 restore 只带来了 build-shared，这里补一个 git repo
          if [ ! -d .git ]; then
            git init
            git remote add origin https://github.com/llvm/llvm-project.git
          fi

          git fetch --depth 1 origin tag llvmorg-19.1.6
          git checkout "${LLVM_COMMIT}"

      - name: Build LLVM/MLIR (only if cache miss)
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          cd llvm-project
          cmake -G Ninja -S llvm -B llvm/build-shared \
            -DLLVM_ENABLE_PROJECTS="mlir;clang" \
            -DBUILD_SHARED_LIBS=ON \
            -DMLIR_ENABLE_BINDINGS_PYTHON=ON \
            -DPython3_EXECUTABLE=python3 \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_TARGETS_TO_BUILD="host"

          ninja -C llvm/build-shared
         

      # LLVM build 完成后立即保存缓存，避免后续测试影响缓存内容
      - name: Save LLVM build cache
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            llvm-project/llvm/build-shared
          key: llvm-${{ runner.os }}-${{ env.LLVM_COMMIT }}-shared-mlirpy

      - name: Build PTOAS
        run: |
          export PYBIND11_CMAKE_DIR="$(python3 -m pybind11 --cmakedir)"
          cmake -G Ninja -S . -B build \
            -DLLVM_DIR="${LLVM_DIR}/lib/cmake/llvm" \
            -DMLIR_DIR="${LLVM_DIR}/lib/cmake/mlir" \
            -DPython3_EXECUTABLE=python3 \
            -DPython3_FIND_STRATEGY=LOCATION \
            -Dpybind11_DIR="${PYBIND11_CMAKE_DIR}" \
            -DMLIR_ENABLE_BINDINGS_PYTHON=ON \
            -DMLIR_PYTHON_PACKAGE_DIR="${LLVM_DIR}/tools/mlir/python_packages/mlir_core" \
            -DCMAKE_INSTALL_PREFIX="${PTO_INSTALL_DIR}" \
            -DCMAKE_BUILD_TYPE=Release
          ninja -C build ptoas
          ninja -C build install

      - name: Run sample tests
        env:
          PTOAS_BIN: ${{ github.workspace }}/build/tools/ptoas/ptoas
          PYTHON_BIN: /usr/bin/python3
          MLIR_PYTHON_ROOT: ${{ env.MLIR_PYTHONPATH }}
          PTO_PYTHON_ROOT: ${{ env.PTO_INSTALL_DIR }}/
          PYTHONPATH: ${{ env.MLIR_PYTHON_ROOT }}:${{ env.PTO_PYTHON_ROOT }}
        run: |
          export PYTHONPATH="${MLIR_PYTHON_ROOT}:${PTO_PYTHON_ROOT}:${PYTHONPATH}"
          export LD_LIBRARY_PATH="${LLVM_DIR}/lib:${PTO_INSTALL_DIR}/lib:${LD_LIBRARY_PATH}"
          bash test/samples/runop.sh all
