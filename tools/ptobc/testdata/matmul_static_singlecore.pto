module attributes {"pto.device-spec" = "Ascend910B1"} {
  func.func @RunTMATMULSplitK(%arg0: !pto.ptr<f32>, %arg1: !pto.ptr<f32>, %arg2: !pto.ptr<f32>, %arg3: !pto.ptr<f32>, %arg4: i1) {
    pto.section.cube {
      %c0 = arith.constant 0 : index
      %c1 = arith.constant 1 : index
      %c1_0 = arith.constant 1 : index
      %c32 = arith.constant 32 : index
      %c256 = arith.constant 256 : index
      %c32_1 = arith.constant 32 : index
      %c32_2 = arith.constant 32 : index
      %c8 = arith.constant 8 : index
      %c32_3 = arith.constant 32 : index
      %c32_4 = arith.constant 32 : index
      %0 = pto.make_tensor_view %arg1, shape = [%c32, %c256] strides = [%c256, %c1] : !pto.tensor_view<?x?xf32>
      %1 = pto.make_tensor_view %arg2, shape = [%c256, %c32_1] strides = [%c32_1, %c1] : !pto.tensor_view<?x?xf32>
      %2 = pto.make_tensor_view %arg0, shape = [%c32, %c32_1] strides = [%c32_1, %c1] : !pto.tensor_view<?x?xf32>
      %3 = pto.make_tensor_view %arg3, shape = [%c1_0, %c32_1] strides = [%c32_1, %c1] : !pto.tensor_view<?x?xf32>
      %4 = pto.alloc_tile : !pto.tile_buf<loc=mat, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=col_major, slayout=row_major, fractal=512, pad=0>
      %5 = pto.alloc_tile : !pto.tile_buf<loc=mat, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=col_major, slayout=row_major, fractal=512, pad=0>
      %6 = pto.alloc_tile : !pto.tile_buf<loc=mat, dtype=f32, rows=1, cols=32, v_row=1, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>
      %7 = pto.alloc_tile : !pto.tile_buf<loc=left, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=row_major, fractal=512, pad=0>
      %8 = pto.alloc_tile : !pto.tile_buf<loc=right, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=col_major, fractal=512, pad=0>
      %9 = pto.alloc_tile : !pto.tile_buf<loc=acc, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=col_major, slayout=row_major, fractal=1024, pad=0>
      %10 = pto.alloc_tile : !pto.tile_buf<loc=bias, dtype=f32, rows=1, cols=32, v_row=1, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>
      scf.for %arg5 = %c0 to %c8 step %c1 {
        %12 = arith.muli %arg5, %c32_2 : index
        %13 = pto.partition_view %0, offsets = [%c0, %12], sizes = [%c32_3, %c32_2] : !pto.tensor_view<?x?xf32> -> !pto.partition_tensor_view<32x32xf32>
        %14 = pto.partition_view %1, offsets = [%12, %c0], sizes = [%c32_2, %c32_4] : !pto.tensor_view<?x?xf32> -> !pto.partition_tensor_view<32x32xf32>
        %15 = pto.partition_view %3, offsets = [%c0, %c0], sizes = [%c1_0, %c32_4] : !pto.tensor_view<?x?xf32> -> !pto.partition_tensor_view<1x32xf32>
        pto.tload ins(%13 : !pto.partition_tensor_view<32x32xf32>) outs(%4 : !pto.tile_buf<loc=mat, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=col_major, slayout=row_major, fractal=512, pad=0>)
        pto.tload ins(%14 : !pto.partition_tensor_view<32x32xf32>) outs(%5 : !pto.tile_buf<loc=mat, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=col_major, slayout=row_major, fractal=512, pad=0>)
        scf.if %arg4 {
          pto.tload ins(%15 : !pto.partition_tensor_view<1x32xf32>) outs(%6 : !pto.tile_buf<loc=mat, dtype=f32, rows=1, cols=32, v_row=1, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>)
        } else {
        }
        pto.record_event[<TLOAD>, <TMOV_M2L>, <EVENT_ID0>]
        pto.wait_event[<TLOAD>, <TMOV_M2L>, <EVENT_ID0>]
        pto.tmov ins(%4 : !pto.tile_buf<loc=mat, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=col_major, slayout=row_major, fractal=512, pad=0>) outs(%7 : !pto.tile_buf<loc=left, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=row_major, fractal=512, pad=0>)
        pto.tmov ins(%5 : !pto.tile_buf<loc=mat, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=col_major, slayout=row_major, fractal=512, pad=0>) outs(%8 : !pto.tile_buf<loc=right, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=col_major, fractal=512, pad=0>)
        scf.if %arg4 {
          pto.tmov ins(%6 : !pto.tile_buf<loc=mat, dtype=f32, rows=1, cols=32, v_row=1, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>) outs(%10 : !pto.tile_buf<loc=bias, dtype=f32, rows=1, cols=32, v_row=1, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>)
        } else {
        }
        pto.record_event[<TMOV_M2L>, <TMATMUL>, <EVENT_ID0>]
        pto.wait_event[<TMOV_M2L>, <TMATMUL>, <EVENT_ID0>]
        %16 = arith.cmpi eq, %arg5, %c0 : index
        scf.if %16 {
          scf.if %arg4 {
            pto.tmatmul.bias ins(%7, %8, %10 : !pto.tile_buf<loc=left, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=row_major, fractal=512, pad=0>, !pto.tile_buf<loc=right, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=col_major, fractal=512, pad=0>, !pto.tile_buf<loc=bias, dtype=f32, rows=1, cols=32, v_row=1, v_col=32, blayout=row_major, slayout=none_box, fractal=512, pad=0>) outs(%9 : !pto.tile_buf<loc=acc, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=col_major, slayout=row_major, fractal=1024, pad=0>)
          } else {
            pto.tmatmul ins(%7, %8 : !pto.tile_buf<loc=left, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=row_major, fractal=512, pad=0>, !pto.tile_buf<loc=right, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=col_major, fractal=512, pad=0>) outs(%9 : !pto.tile_buf<loc=acc, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=col_major, slayout=row_major, fractal=1024, pad=0>)
          }
        } else {
          pto.tmatmul.acc ins(%9, %7, %8 : !pto.tile_buf<loc=acc, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=col_major, slayout=row_major, fractal=1024, pad=0>, !pto.tile_buf<loc=left, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=row_major, fractal=512, pad=0>, !pto.tile_buf<loc=right, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=row_major, slayout=col_major, fractal=512, pad=0>) outs(%9 : !pto.tile_buf<loc=acc, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=col_major, slayout=row_major, fractal=1024, pad=0>)
        }
        pto.record_event[<TMATMUL>, <TLOAD>, <EVENT_ID0>]
        pto.wait_event[<TMATMUL>, <TLOAD>, <EVENT_ID0>]
      }
      pto.record_event[<TMATMUL>, <TSTORE_ACC>, <EVENT_ID0>]
      pto.wait_event[<TMATMUL>, <TSTORE_ACC>, <EVENT_ID0>]
      %11 = pto.partition_view %2, offsets = [%c0, %c0], sizes = [%c32_3, %c32_4] : !pto.tensor_view<?x?xf32> -> !pto.partition_tensor_view<32x32xf32>
      pto.tstore ins(%9 : !pto.tile_buf<loc=acc, dtype=f32, rows=32, cols=32, v_row=32, v_col=32, blayout=col_major, slayout=row_major, fractal=1024, pad=0>) outs(%11 : !pto.partition_tensor_view<32x32xf32>)
    }
    return
  }
}

